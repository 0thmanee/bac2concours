// IncubationOS - Prisma Schema
// Defines the complete database schema for MVP

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  ADMIN
  STUDENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum PaymentStatus {
  NOT_SUBMITTED
  PENDING
  APPROVED
  REJECTED
}

enum BookStatus {
  ACTIVE
  INACTIVE
  PROCESSING
}

enum FileType {
  IMAGE // Covers, profile pictures
  DOCUMENT // PDFs, books
  PAYMENT_PROOF // Payment verification documents
  OTHER
}

enum ReviewableType {
  BOOK
  VIDEO
  COURSE
  ARTICLE
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

enum VideoStatus {
  ACTIVE
  INACTIVE
  PROCESSING
}

enum SchoolStatus {
  ACTIVE
  INACTIVE
  DRAFT
}

enum SchoolType {
  UNIVERSITE
  ECOLE_INGENIEUR
  ECOLE_COMMERCE
  INSTITUT
  FACULTE
}

// ============================================================
// USER & AUTHENTICATION
// ============================================================

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  password      String // Hashed password
  name          String
  role          UserRole
  status        UserStatus @default(INACTIVE)
  emailVerified DateTime? // Null if not verified

  // Payment verification
  paymentStatus          PaymentStatus @default(NOT_SUBMITTED)
  paymentProofUrl        String? // URL de la preuve de paiement
  paymentRejectionReason String? // Raison du rejet si applicable
  paymentSubmittedAt     DateTime? // Date de soumission de la preuve
  paymentReviewedAt      DateTime? // Date de révision par l'admin

  // Relations
  notifications           Notification[]
  notificationPreferences NotificationPreference? @relation("NotificationPreferences")
  books                   Book[] // Books uploaded by this user (admin)
  videos                  Video[] // Videos uploaded by this user (admin)
  schools                 School[] // Schools uploaded by this user (admin)
  uploadedFiles           File[] // Files uploaded by this user
  reviews                 Review[] // Reviews written by this user
  questions               Question[] // Questions uploaded by this user (admin)
  quizAttempts            QuizAttempt[] // Quiz attempts by this user (student)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([paymentStatus])
  @@map("users")
}

// ============================================================
// INCUBATOR SETTINGS
// ============================================================

model IncubatorSettings {
  id            String @id @default(cuid())
  incubatorName String

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("incubator_settings")
}

// ============================================================
// NOTIFICATIONS
// ============================================================

enum NotificationType {
  USER_ACTIVATED
  USER_DEACTIVATED
  NEW_USER_REGISTERED
  SYSTEM_ANNOUNCEMENT
  PAYMENT_SUBMITTED // Student submitted payment proof (for admins)
  PAYMENT_APPROVED // Payment was approved (for student)
  PAYMENT_REJECTED // Payment was rejected (for student)
  NEW_RESOURCE // New book/video/qcm available (for students)
}

enum NotificationChannel {
  IN_APP
  EMAIL
  BOTH
}

model Notification {
  id      String              @id @default(cuid())
  type    NotificationType
  title   String
  message String              @db.Text
  data    Json?
  isRead  Boolean             @default(false)
  channel NotificationChannel @default(IN_APP)

  // Recipient
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Audit
  createdAt DateTime  @default(now())
  readAt    DateTime?

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationPreference {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation("NotificationPreferences", fields: [userId], references: [id], onDelete: Cascade)

  // Per-type preferences
  systemAnnouncements NotificationChannel @default(EMAIL)

  // Email digest preference
  emailDigest Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("notification_preferences")
}

// ============================================================
// EMAIL VERIFICATION & PASSWORD RESET
// ============================================================

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  createdAt DateTime @default(now())

  @@unique([email, token])
  @@index([email])
  @@index([token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  createdAt DateTime @default(now())

  @@unique([email, token])
  @@index([email])
  @@index([token])
  @@map("password_reset_tokens")
}

// ============================================================
// EDUCATIONAL RESOURCES - BOOKS
// ============================================================

model Book {
  id          String  @id @default(cuid())
  title       String
  author      String
  school      String // e.g., "Sciences Mathématiques", "Sciences Physiques"
  category    String // e.g., "Mathématiques", "Physique"
  description String? @db.Text

  // Cover image - uploaded file only
  coverFileId String? // FK to File model
  coverFile   File?   @relation("BookCoverFile", fields: [coverFileId], references: [id], onDelete: SetNull)

  // PDF file - Google Drive link only
  fileUrl    String // Google Drive or external link to PDF
  fileName   String
  fileSize   String // e.g., "25.4 MB"
  totalPages Int
  language   String     @default("fr")
  level      String // e.g., "Terminale", "Première"
  subject    String // Same as category for consistency
  tags       String[] // Array of tags for filtering
  downloads  Int        @default(0)
  views      Int        @default(0)
  rating     Float      @default(0)
  status     BookStatus @default(ACTIVE)
  isPublic   Boolean    @default(true)

  // Relations
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  reviews      Review[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([category])
  @@index([level])
  @@index([isPublic])
  @@index([uploadedById])
  @@index([coverFileId])
  @@map("books")
}

// ============================================================
// EDUCATIONAL RESOURCES - VIDEOS
// ============================================================

model Video {
  id          String  @id @default(cuid())
  title       String
  description String? @db.Text
  url         String // YouTube URL only

  // Thumbnail - uploaded file only
  thumbnailFileId String? // FK to File model
  thumbnailFile   File?   @relation("VideoThumbnailFile", fields: [thumbnailFileId], references: [id], onDelete: SetNull)

  school   String // e.g., "Sciences Mathématiques", "Sciences Physiques"
  category String // e.g., "Mathématiques", "Physique"
  level    String // e.g., "Terminale", "Première"
  subject  String // Same as category for consistency
  tags     String[] // Array of tags for filtering
  duration Int? // Duration in seconds
  views    Int         @default(0)
  rating   Float       @default(0)
  status   VideoStatus @default(ACTIVE)
  isPublic Boolean     @default(true)

  // YouTube video ID (auto-extracted from URL)
  youtubeId String? // YouTube video ID

  // Relations
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  reviews      Review[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([category])
  @@index([level])
  @@index([isPublic])
  @@index([uploadedById])
  @@index([thumbnailFileId])
  @@map("videos")
}

// ============================================================
// FILE MANAGEMENT
// ============================================================

model File {
  id          String   @id @default(cuid())
  filename    String // Original filename
  storagePath String // Path in Firebase Storage
  publicUrl   String // Public access URL
  mimeType    String // e.g., "image/jpeg", "application/pdf"
  size        Int // File size in bytes
  type        FileType // Category of file

  // Relations
  uploadedById String
  uploadedBy   User   @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  // Reverse relations for books, videos, schools, and questions
  bookCovers      Book[]     @relation("BookCoverFile")
  videoThumbnails Video[]    @relation("VideoThumbnailFile")
  schoolImages    School[]   @relation("SchoolImageFile")
  schoolLogos     School[]   @relation("SchoolLogoFile")
  questionImages  Question[] @relation("QuestionImageFile")

  // Metadata
  metadata Json? // Additional file-specific metadata

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([uploadedById])
  @@index([type])
  @@index([createdAt])
  @@map("files")
}

// ============================================================
// REVIEWS (Polymorphic - for Books, Videos, Courses, etc.)
// ============================================================

model Review {
  id      String       @id @default(cuid())
  rating  Int // 1-5 stars
  comment String?      @db.Text
  status  ReviewStatus @default(PENDING)

  // Polymorphic relation fields
  reviewableType ReviewableType // Type of resource being reviewed
  reviewableId   String // ID of the resource being reviewed

  // Specific relations (optional - based on reviewableType)
  bookId String?
  book   Book?   @relation(fields: [bookId], references: [id], onDelete: Cascade)

  videoId String?
  video   Video?  @relation(fields: [videoId], references: [id], onDelete: Cascade)

  // Author of the review
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Moderation
  isVerifiedPurchase Boolean   @default(false) // For future e-commerce integration
  helpfulCount       Int       @default(0) // Number of users who found this helpful
  reportCount        Int       @default(0) // Number of times reported
  moderatedAt        DateTime?
  moderatedBy        String? // Admin user ID who moderated

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reviewableType, reviewableId])
  @@index([bookId])
  @@index([videoId])
  @@index([userId])
  @@index([status])
  @@index([rating])
  @@index([createdAt])
  @@map("reviews")
}

// ============================================================
// EDUCATIONAL RESOURCES - SCHOOLS (ÉCOLES)
// ============================================================

model School {
  id              String     @id @default(cuid())
  name            String
  shortName       String? // e.g., "ENSIAS", "ENSA", "FSR"
  type            SchoolType
  description     String     @db.Text
  longDescription String?    @db.Text

  // Images - uploaded files only
  imageFileId String? // Main image FK to File model
  imageFile   File?   @relation("SchoolImageFile", fields: [imageFileId], references: [id], onDelete: SetNull)
  logoFileId  String? // Logo FK to File model
  logoFile    File?   @relation("SchoolLogoFile", fields: [logoFileId], references: [id], onDelete: SetNull)

  // Location Information
  city    String
  address String?
  region  String?

  // Contact Information
  phone   String?
  email   String?
  website String?

  // Admission Information
  seuilDeSelection Float? // Selection threshold (note minimale)
  documentsRequis  String[] // Required documents
  datesConcours    String? // Exam dates
  fraisInscription Float? // Registration fees
  bourses          Boolean  @default(false) // Scholarships available

  // Statistics
  nombreEtudiants    Int? // Number of students
  tauxReussite       Float? // Success rate (percentage)
  classementNational Int? // National ranking

  // Programs and details (JSON for flexibility)
  programs        Json? // Array of program objects
  specializations String[] // e.g., ["Intelligence Artificielle", "Cybersécurité"]
  avantages       String[] // Benefits/advantages
  services        String[] // Available services
  infrastructures String[] // Facilities
  partenariats    String[] // Partnerships

  // Meta Information
  isPublic        Boolean      @default(true)
  featured        Boolean      @default(false)
  establishedYear Int?
  status          SchoolStatus @default(DRAFT)

  // Relations
  uploadedById String
  uploadedBy   User   @relation(fields: [uploadedById], references: [id])

  // Stats
  views Int @default(0)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([type])
  @@index([city])
  @@index([isPublic])
  @@index([featured])
  @@index([uploadedById])
  @@map("schools")
}

// ============================================================
// QCM - QUESTIONS & QUIZZES
// ============================================================

enum QuestionDifficulty {
  EASY
  MEDIUM
  HARD
}

enum QuestionStatus {
  ACTIVE
  INACTIVE
  DRAFT
}

model Question {
  id          String   @id @default(cuid())
  text        String   @db.Text // Question text (supports HTML/Markdown for math)
  options     Json // Array of options: [{id, text, imageUrl?}]
  correctIds  String[] // Array of correct option IDs (supports multiple correct answers)
  explanation String?  @db.Text // Explanation shown after answering

  // Categorization
  school     String // e.g., "Sciences Mathématiques", "Sciences Physiques"  
  matiere    String // e.g., "Mathématiques", "Physique"
  chapter    String? // Optional chapter/topic
  difficulty QuestionDifficulty @default(MEDIUM)

  // Media support
  imageFileId String? // Optional image for the question
  imageFile   File?   @relation("QuestionImageFile", fields: [imageFileId], references: [id], onDelete: SetNull)

  // Metadata
  tags      String[]
  points    Int            @default(1) // Points for this question
  timeLimit Int? // Optional time limit in seconds
  status    QuestionStatus @default(ACTIVE)
  isPublic  Boolean        @default(true)

  // Stats
  timesAnswered Int @default(0)
  timesCorrect  Int @default(0)

  // Relations
  uploadedById String
  uploadedBy   User         @relation(fields: [uploadedById], references: [id])
  quizAnswers  QuizAnswer[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([school])
  @@index([matiere])
  @@index([difficulty])
  @@index([status])
  @@index([isPublic])
  @@index([uploadedById])
  @@map("questions")
}

model QuizAttempt {
  id String @id @default(cuid())

  // Quiz configuration
  school         String // Filter used for this quiz
  matiere        String // Filter used for this quiz
  totalQuestions Int

  // Results
  score       Int   @default(0) // Number of correct answers
  totalPoints Int   @default(0) // Total points earned
  maxPoints   Int   @default(0) // Maximum possible points
  percentage  Float @default(0) // Score percentage
  timeSpent   Int? // Total time in seconds

  // Status
  completedAt DateTime?

  // Relations
  userId  String
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers QuizAnswer[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([school])
  @@index([matiere])
  @@index([completedAt])
  @@index([createdAt])
  @@map("quiz_attempts")
}

model QuizAnswer {
  id String @id @default(cuid())

  // Answer data
  selectedIds  String[] // IDs of selected options
  isCorrect    Boolean
  pointsEarned Int      @default(0)
  timeSpent    Int? // Time spent on this question in seconds

  // Relations
  attemptId  String
  attempt    QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  questionId String
  question   Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  // Audit
  createdAt DateTime @default(now())

  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
  @@map("quiz_answers")
}

// ============================================================
// SETTINGS RESOURCES - Categories, Levels, Matieres
// ============================================================

model Category {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  isActive    Boolean @default(true)
  order       Int     @default(0)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([order])
  @@map("categories")
}

model Level {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  isActive    Boolean @default(true)
  order       Int     @default(0)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([order])
  @@map("levels")
}

model Matiere {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  isActive    Boolean @default(true)
  order       Int     @default(0)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([order])
  @@map("matieres")
}
